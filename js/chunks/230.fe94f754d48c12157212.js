"use strict";(self.webpackChunktoilet_review_system_frontend=self.webpackChunktoilet_review_system_frontend||[]).push([[230],{230(e,t,n){n.r(t),n.d(t,{HomePage:()=>b});var a=n(467),i=n(848),r=n(29),o=n(901),s=n(388),c=n(954),l=n(361),u=n(756),p=n(758),d=n(851),h=n(134),v=n(277);n(338);function f(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,a)}return n}function m(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?f(Object(n),!0).forEach(function(t){(0,a.A)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):f(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function y(e,t,n){return t=(0,c.A)(t),(0,s.A)(e,g()?Reflect.construct(t,n||[],(0,c.A)(e).constructor):t.apply(e,n))}function g(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(g=function(){return!!e})()}var b=function(e){function t(){var e;return(0,r.A)(this,t),(e=y(this,t)).map=null,e.markers=null,e.qrScanner=null,e.isProcessingScan=!1,e.initializeMap=e.initializeMap.bind(e),e.initializeSearch=e.initializeSearch.bind(e),e.loadToilets=e.loadToilets.bind(e),e.updateHomePageStats=e.updateHomePageStats.bind(e),e.syncAllDataSources=e.syncAllDataSources.bind(e),e.updateToiletFilters=e.updateToiletFilters.bind(e),e.onScanSuccess=e.onScanSuccess.bind(e),e.onScanFailure=e.onScanFailure.bind(e),e.resetScanner=e.resetScanner.bind(e),e.loadToiletInfo=e.loadToiletInfo.bind(e),e.createMarker=e.createMarker.bind(e),e.createPopupContent=e.createPopupContent.bind(e),e.getStarRating=e.getStarRating.bind(e),e.updateMapStats=e.updateMapStats.bind(e),e}return(0,l.A)(t,e),(0,o.A)(t,[{key:"init",value:(g=(0,i.A)(u.mark(function e(){return u.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.setupStateObservers(),e.next=1,this.initializeMap();case 1:return e.next=2,this.initializeSearch();case 2:return this.initializeQRScanner(),e.next=3,this.updateHomePageStats();case 3:this.setupEventListeners();case 4:case"end":return e.stop()}},e,this)})),function(){return g.apply(this,arguments)})},{key:"setupStateObservers",value:function(){var e=this;d.Ay.subscribe("state:changed",function(t,n){n.changes["data.toilets"]&&e.updateMapWithToilets(n.changes["data.toilets"].to)})}},{key:"setupEventListeners",value:function(){var e=this,t=(0,h.$)("#showPublicToilets"),n=(0,h.$)("#showPrivateToilets");t&&t.addEventListener("change",this.updateToiletFilters),n&&n.addEventListener("change",this.updateToiletFilters);var a=(0,h.$)('button[onclick*="syncAllDataSources"]');a&&a.addEventListener("click",this.syncAllDataSources);var i=(0,h.$)('button[onclick*="locate"]');i&&i.addEventListener("click",function(){e.map&&e.map.locate({setView:!0,maxZoom:16})})}},{key:"initializeMap",value:(f=(0,i.A)(u.mark(function e(){var t,n,a,i,r,o,s,c,l=this;return u.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=(0,h.$)("#map"),n=(0,h.$)("#map-error"),t){e.next=1;break}return e.abrupt("return");case 1:if(t.style.height="500px",t.style.width="100%",e.prev=2,"undefined"!=typeof L){e.next=3;break}throw new Error("Leaflet library not loaded");case 3:return this.map=L.map(t,{center:(null===(a=v.A.map)||void 0===a?void 0:a.defaultCenter)||[18.5204,73.8567],zoom:(null===(i=v.A.map)||void 0===i?void 0:i.defaultZoom)||13,minZoom:(null===(r=v.A.map)||void 0===r?void 0:r.minZoom)||3,maxZoom:(null===(o=v.A.map)||void 0===o?void 0:o.maxZoom)||19,zoomControl:!0,preferCanvas:!0,zoomAnimation:!0,markerZoomAnimation:!0}),void 0!==L.markerClusterGroup?this.markers=L.markerClusterGroup({chunkedLoading:!0,maxClusterRadius:(null===(s=v.A.map)||void 0===s?void 0:s.maxClusterRadius)||50,spiderfyOnMaxZoom:!0,showCoverageOnHover:!0,zoomToBoundsOnClick:!0,animate:!0,animateAddingMarkers:!0,disableClusteringAtZoom:16}):this.markers=L.layerGroup(),L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",{attribution:"¬©OpenStreetMap, ¬©CartoDB",subdomains:"abcd",maxZoom:19,updateWhenIdle:!0,keepBuffer:2}).addTo(this.map),this.map.addLayer(this.markers),this.setupMapEventHandlers(),setTimeout(function(){l.map.invalidateSize()},100),e.next=4,this.loadToilets();case 4:e.next=6;break;case 5:e.prev=5,c=e.catch(2),n&&(n.textContent="Failed to initialize map: ".concat(c.message),n.style.display="block");case 6:case"end":return e.stop()}},e,this,[[2,5]])})),function(){return f.apply(this,arguments)})},{key:"setupMapEventHandlers",value:function(){var e=this;this.map&&(this.map.on("click",function(e){}),this.map.on("locationfound",function(t){L.marker(t.latlng).addTo(e.map).bindPopup("You are here!").openPopup()}),this.map.on("locationerror",function(e){d.Ay.addNotification({type:"warning",title:"Location Error",message:"Unable to determine your location",duration:3e3})}),this.map.on("tileerror",function(e){}))}},{key:"initializeSearch",value:(p=(0,i.A)(u.mark(function e(){var t,n,a,i,r;return u.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:try{(t=(0,h.$)("#search-container"))&&(t.innerHTML='\n                    <div class="search-simplified">\n                        <input\n                            type="text"\n                            id="search-input"\n                            placeholder="Search for toilets..."\n                            class="search-input"\n                        />\n                        <button id="search-btn" class="btn btn-primary">Search</button>\n                    </div>\n                ',n=(0,h.$)("#search-input"),a=(0,h.$)("#search-btn"),n&&a&&(i=function(){n.value.trim()},a.addEventListener("click",i),n.addEventListener("keypress",function(e){"Enter"===e.key&&i()})))}catch(e){(r=(0,h.$)("#search-container"))&&(r.innerHTML='\n                    <div style="color: #dc3545; padding: 1rem; text-align: center; border: 1px solid #dc3545; border-radius: 4px;">\n                        Search temporarily unavailable. Map functionality still works.\n                    </div>\n                ')}case 1:case"end":return e.stop()}},e)})),function(){return p.apply(this,arguments)})},{key:"loadToilets",value:(c=(0,i.A)(u.mark(function e(){var t,n,a,i,r,o,s,c,l,p;return u.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=(0,h.$)("#map-loading"),n=(0,h.$)("#map-error"),t&&(t.style.display="flex"),n&&(n.style.display="none"),d.Ay.setLoading("toilets",!0),e.prev=1,a=this.map.getBounds(),i="".concat(a.getSouth(),",").concat(a.getWest(),",").concat(a.getNorth(),",").concat(a.getEast()),r=d.Ay.getState().settings.mapFilters,o=new URLSearchParams({showPublic:r.showPublic.toString(),showPrivate:r.showPrivate.toString(),bounds:i,limit:"1000"}),e.next=2,fetch("".concat(v.A.api.baseUrl,"/api/toilet/map?").concat(o));case 2:if((s=e.sent).ok){e.next=3;break}throw new Error("API request failed: ".concat(s.status));case 3:return e.next=4,s.json();case 4:c=e.sent,l=c.success?c.data:c,d.Ay.setToilets(l),this.updateMapStats(l),e.next=6;break;case 5:e.prev=5,p=e.catch(1),n&&(n.textContent="Error loading toilets: ".concat(p.message),n.style.display="block");case 6:return e.prev=6,d.Ay.setLoading("toilets",!1),t&&(t.style.display="none"),e.finish(6);case 7:case"end":return e.stop()}},e,this,[[1,5,6,7]])})),function(){return c.apply(this,arguments)})},{key:"updateMapWithToilets",value:function(e){var t=this;this.markers&&e&&(this.markers.clearLayers(),e.forEach(function(e){var n,a;if(null!==(n=e.coordinates)&&void 0!==n&&n.latitude&&null!==(a=e.coordinates)&&void 0!==a&&a.longitude)try{var i=t.createMarker(e),r=t.createPopupContent(e);i.bindPopup(r),t.markers.addLayer(i)}catch(e){}}),this.markers.getLayers().length>0&&this.map.fitBounds(this.markers.getBounds(),{padding:[50,50],maxZoom:15,animate:!0,duration:1}))}},{key:"createMarker",value:function(e){var t=L.divIcon({className:"toilet-marker",html:'<div style="\n                width: 20px;\n                height: 20px;\n                border-radius: 50%;\n                background-color: '.concat(this.getMarkerColor(e.averageRating),';\n                border: 3px solid white;\n                box-shadow: 0 2px 4px rgba(0,0,0,0.3);\n                transition: all 0.3s ease;\n            "></div>'),iconSize:[20,20],iconAnchor:[10,10]});return L.marker([e.coordinates.latitude,e.coordinates.longitude],{icon:t})}},{key:"getMarkerColor",value:function(e){return e?e>=4?"#4caf50":e>=3?"#ffc107":"#f44336":"#808080"}},{key:"createPopupContent",value:function(e){var t="public"===e.type;return'\n            <div class="toilet-popup '.concat(t?"public-popup":"private-popup",'">\n                <h3>').concat(e.name,'</h3>\n                <div class="toilet-type ').concat(t?"public-badge":"private-badge",'">\n                    ').concat(t?"üèõÔ∏è Public Facility":"üè¢ Private Toilet","\n                </div>\n                <p>").concat(e.location,"</p>\n                ").concat(e.description?"<p>".concat(e.description,"</p>"):"","\n\n                ").concat(t?'\n                    <div class="public-notice">\n                        ‚ÑπÔ∏è Public facility - General information only\n                    </div>\n                ':'\n                    <div class="rating">\n                        <span class="rating-stars">'.concat(this.getStarRating(e.averageRating),"</span>\n                        <span>(").concat(e.averageRating?e.averageRating.toFixed(1):"No"," / 5)</span>\n                    </div>\n                    <p>Total Reviews: ").concat(e.totalReviews||0,"</p>\n                "),"\n\n                ").concat(e.facilities?"\n                    <p>Facilities: ".concat(e.facilities.map(function(e){return e.replace("_"," ")}).join(", "),"</p>\n                "):"","\n\n                ").concat(t?"":"<button onclick=\"reviewToilet('".concat(e.id,"')\">Write Review</button>"),"\n            </div>\n        ")}},{key:"getStarRating",value:function(e){if(!e)return"No ratings yet";var t=Math.floor(e),n=e%1>=.5,a="‚òÖ".repeat(t);return n&&(a+="¬Ω"),a+="‚òÜ".repeat(5-Math.ceil(e))}},{key:"updateToiletFilters",value:function(){var e,t,n,a,i=null===(e=null===(t=(0,h.$)("#showPublicToilets"))||void 0===t?void 0:t.checked)||void 0===e||e,r=null===(n=null===(a=(0,h.$)("#showPrivateToilets"))||void 0===a?void 0:a.checked)||void 0===n||n;d.Ay.setState(function(e){return m(m({},e),{},{settings:m(m({},e.settings),{},{mapFilters:{showPublic:i,showPrivate:r}})})}),this.loadToilets()}},{key:"syncAllDataSources",value:(s=(0,i.A)(u.mark(function e(){var t,n,a,i,r,o,s,c=this;return u.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,d.Ay.setLoading("sync",!0),null==(t=(0,h.$)('button[onclick*="syncAllDataSources"]'))||t.textContent,t&&(t.textContent="üîÑ Syncing All APIs..."),n=this.map.getBounds(),a="".concat(n.getSouth(),",").concat(n.getWest(),",").concat(n.getNorth(),",").concat(n.getEast()),i=["osm","government","geofabrik","city_ckan","planet_osm","data.gov.in","swachh_bharat","municipal","tourism_boards","transport_hubs","commercial_centers","educational_institutions"].map(function(e){return fetch("".concat(v.A.api.baseUrl,"/api/toilet/sync-public"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({bounds:a,sources:[e],city:c.getCurrentCityFromBounds(n)})}).then(function(t){return t.ok?t.json():{synced:0,source:e}}).catch(function(){return{synced:0,source:e}})}),e.next=1,Promise.allSettled(i);case 1:return r=e.sent,o=r.reduce(function(e,t){return"fulfilled"===t.status?e+(t.value.synced||0):e},0),e.next=2,Promise.all([this.loadToilets(),this.updateHomePageStats()]);case 2:d.Ay.addNotification({type:"success",title:"Sync Complete",message:"Successfully synced ".concat(o," new toilets from all external APIs!"),duration:5e3}),e.next=4;break;case 3:e.prev=3,e.catch(0),d.Ay.addNotification({type:"error",title:"Sync Failed",message:"Failed to sync data from external APIs. Please try again.",duration:5e3});case 4:return e.prev=4,d.Ay.setLoading("sync",!1),(s=(0,h.$)('button[onclick*="syncAllDataSources"]'))&&(s.textContent="üîÑ Sync All APIs"),e.finish(4);case 5:case"end":return e.stop()}},e,this,[[0,3,4,5]])})),function(){return s.apply(this,arguments)})},{key:"getCurrentCityFromBounds",value:function(e){var t=e.getCenter(),n=t.lat,a=t.lng;return n>28.4&&n<28.9&&a>76.8&&a<77.4?"delhi":n>18.8&&n<19.3&&a>72.7&&a<73?"mumbai":n>12.7&&n<13.2&&a>77.3&&a<77.9?"bangalore":n>12.9&&n<13.3&&a>80.1&&a<80.4?"chennai":n>18.3&&n<18.7&&a>73.7&&a<74?"pune":"mumbai"}},{key:"updateHomePageStats",value:(a=(0,i.A)(u.mark(function e(){var t,n,a,i,r;return u.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=1,fetch("".concat(v.A.api.baseUrl,"/api/toilet/stats"));case 1:if(!(t=e.sent).ok){e.next=3;break}return e.next=2,t.json();case 2:n=e.sent,a=(0,h.$)("#totalToiletsCount"),i=(0,h.$)("#citiesCovered"),r=(0,h.$)("#reviewsCount"),a&&(a.textContent=(n.total||0).toLocaleString()+"+"),i&&(i.textContent="".concat(Math.max(n.cities||9,9),"+ Cities")),r&&(r.textContent=(n.totalReviews||500).toLocaleString()+"+");case 3:e.next=5;break;case 4:e.prev=4,e.catch(0);case 5:case"end":return e.stop()}},e,null,[[0,4]])})),function(){return a.apply(this,arguments)})},{key:"updateMapStats",value:function(e){var t=(0,h.$)("#map-stats-content");if(t)if(e&&0!==e.length){var n=e.length,a=e.reduce(function(e,t){return e+(t.averageRating||0)},0)/n,i=e.filter(function(e){return e.averageRating>=4}).length,r=e.filter(function(e){return e.totalReviews>0}).length;t.innerHTML="\n            <p>Total Toilets: ".concat(n,"</p>\n            <p>Average Rating: ").concat(a.toFixed(1)," ‚≠ê</p>\n            <p>High Rated (4+): ").concat(i,"</p>\n            <p>Reviewed: ").concat(r,"/").concat(n,"</p>\n        ")}else t.innerHTML="<p>No toilets available yet</p><p>Add toilets via the admin panel</p>"}},{key:"initializeQRScanner",value:function(){var e=(0,h.$)("#qr-reader");if(e)if("undefined"!=typeof Html5Qrcode)try{this.qrScanner=new Html5QrcodeScanner("qr-reader",{fps:v.A.qrScanner.fps,qrbox:v.A.qrScanner.qrbox,aspectRatio:v.A.qrScanner.aspectRatio,showTorchButtonIfSupported:v.A.qrScanner.showTorchButtonIfSupported,showZoomSliderIfSupported:v.A.qrScanner.showZoomSliderIfSupported},!1),this.qrScanner.render(this.onScanSuccess,this.onScanFailure)}catch(t){e.innerHTML="<p>Error initializing QR scanner. Please refresh the page.</p>"}else e.innerHTML="<p>QR scanner library not available. Please refresh the page.</p>"}},{key:"onScanSuccess",value:function(e,t){if(!this.isProcessingScan){this.isProcessingScan=!0;try{this.qrScanner&&(this.qrScanner.clear(),this.qrScanner=null);var n=(0,h.$)("#qr-reader");if(n&&(n.style.display="none"),e.includes("review.html?id="))try{var a=new URL(e).searchParams.get("id");if(a)return void this.loadToiletInfo(a);throw new Error("No toilet ID found in QR code URL")}catch(e){throw new Error("Invalid QR code URL format")}var i=e.trim();if(i&&i.length>10)return void this.loadToiletInfo(i);throw new Error("Invalid QR code format - not a valid review URL or toilet ID")}catch(e){d.Ay.addNotification({type:"error",title:"Invalid QR Code",message:e.message||"Please scan a valid toilet QR code.",duration:5e3}),this.resetScanner()}finally{this.isProcessingScan=!1}}}},{key:"onScanFailure",value:function(e){e&&!e.includes("No QR code found")&&e.includes("NotFoundException")}},{key:"resetScanner",value:function(){var e=this;this.isProcessingScan=!1,this.qrScanner&&(this.qrScanner.clear(),this.qrScanner=null);var t=(0,h.$)("#toiletInfoPanel"),n=(0,h.$)("#reviewFormSection"),a=(0,h.$)("#successMessage"),i=(0,h.$)("#qr-reader");t&&(t.style.display="none"),n&&(n.style.display="none"),a&&(a.style.display="none"),i&&(i.style.display="block",i.innerHTML=""),this.currentToiletId=null,setTimeout(function(){e.initializeQRScanner()},100)}},{key:"loadToiletInfo",value:(n=(0,i.A)(u.mark(function e(t){var n,a,i,r,o;return u.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=(0,h.$)("#toiletInfoPanel"),a=(0,h.$)("#reviewFormSection"),n&&(n.style.display="block",n.innerHTML='\n                <div style="text-align: center; padding: 2rem;">\n                    <div class="loading-spinner"></div>\n                    <p>Loading toilet information...</p>\n                </div>\n            '),e.prev=1,e.next=2,fetch("".concat(v.A.api.baseUrl,"/api/toilet/").concat(t));case 2:if((i=e.sent).ok){e.next=3;break}throw new Error("Server responded with status: ".concat(i.status));case 3:return e.next=4,i.json();case 4:if(r=e.sent){e.next=5;break}throw new Error("No toilet data received");case 5:this.currentToiletId=r.id||t,this.updateToiletInfoPanel(r),a&&(a.style.display="block"),e.next=7;break;case 6:e.prev=6,o=e.catch(1),n&&(n.innerHTML='\n                    <div style="color: #dc3545; text-align: center; padding: 2rem;">\n                        <h3>Error Loading Toilet Information</h3>\n                        <p>'.concat(o.message,'</p>\n                        <p>Please make sure:</p>\n                        <ul style="text-align: left; margin: 1rem 0;">\n                            <li>The backend server is running</li>\n                            <li>You have a stable internet connection</li>\n                            <li>The toilet ID is valid</li>\n                        </ul>\n                        <button onclick="location.reload()" class="btn" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">\n                            Try Again\n                        </button>\n                    </div>\n                '));case 7:case"end":return e.stop()}},e,this,[[1,6]])})),function(e){return n.apply(this,arguments)})},{key:"updateToiletInfoPanel",value:function(e){var t=(0,h.$)("#toiletInfoPanel");if(t){e.type;t.innerHTML='\n            <h2>Toilet Information</h2>\n            <div class="toilet-details">\n                <div class="info-group">\n                    <h3>'.concat(e.name||"Unknown Toilet","</h3>\n                    <p>").concat(e.location||"Location not specified","</p>\n                    ").concat(e.description?"<p>".concat(e.description,"</p>"):"",'\n                </div>\n                <div class="info-group">\n                    <h4>Current Ratings</h4>\n                    <div class="rating-summary">\n                        <div class="rating-item">\n                            <span>Overall Rating:</span>\n                            <span class="rating-stars">').concat(this.getStarRating(e.averageRating),'</span>\n                        </div>\n                        <div class="rating-item">\n                            <span>Total Reviews:</span>\n                            <span>').concat(e.totalReviews||0,'</span>\n                        </div>\n                    </div>\n                </div>\n                <div class="info-group">\n                    <h4>Facilities</h4>\n                    <div class="facilities-list">\n                        ').concat(e.facilities&&e.facilities.length>0?e.facilities.map(function(e){return'\n                                <span class="facility-tag">\n                                    '.concat(e.replace("_"," ").replace(/\b\w/g,function(e){return e.toUpperCase()}),"\n                                </span>\n                            ")}).join(""):"<p>No facilities listed</p>","\n                    </div>\n                </div>\n            </div>\n        ")}}},{key:"destroy",value:function(){this.map&&(this.map.remove(),this.map=null),this.markers&&(this.markers.clearLayers(),this.markers=null),this.qrScanner&&(this.qrScanner.clear(),this.qrScanner=null)}}]);var n,a,s,c,p,f,g}(p.v)}}]);
//# sourceMappingURL=230.fe94f754d48c12157212.js.map